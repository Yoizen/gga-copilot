#!/usr/bin/env bash

# ============================================================================
# Gentleman Guardian Angel - Copilot API Manager
# ============================================================================
# Helper script to install and run the copilot-api proxy.
# ============================================================================

set -e

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
COPILOT_DIR="$HOME/.local/share/gga/copilot-api"
REPO_URL="https://github.com/ericc-ch/copilot-api.git"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

install_copilot() {
  if [ -d "$COPILOT_DIR" ]; then
    echo -e "${BLUE}ℹ️  copilot-api already exists in $COPILOT_DIR${NC}"
    echo "   Pulling latest changes..."
    cd "$COPILOT_DIR" && git pull
  else
    echo -e "${BLUE}ℹ️  Cloning copilot-api to $COPILOT_DIR...${NC}"
    git clone "$REPO_URL" "$COPILOT_DIR"
  fi

  echo -e "${BLUE}ℹ️  Installing dependencies...${NC}"
  cd "$COPILOT_DIR"
  
  if ! command -v bun &> /dev/null; then
    echo -e "${RED}❌ bun not found. Please install bun first: https://bun.sh${NC}"
    exit 1
  fi

  bun install
  echo -e "${GREEN}✅ Installation complete!${NC}"
}

start_copilot() {
  if [ ! -d "$COPILOT_DIR" ]; then
    echo -e "${RED}❌ copilot-api not found. Run 'bin/gga-copilot install' first.${NC}"
    exit 1
  fi

  echo -e "${BLUE}ℹ️  Starting copilot-api...${NC}"
  echo "   You may be prompted to authenticate with GitHub."
  
  cd "$COPILOT_DIR"
  bun run start start
}

show_help() {
  echo "Usage: bin/gga-copilot <command>"
  echo ""
  echo "Commands:"
  echo "  install   Clone and install copilot-api"
  echo "  start     Start the copilot-api server"
  echo "  help      Show this help message"
}

case "$1" in
  install)
    install_copilot
    ;;
  start)
    start_copilot
    ;;
  *)
    show_help
    exit 1
    ;;
esac
